<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>Flot Examples: Pie Charts</title>
    <!-- JQuery -->
	<script language="javascript" type="text/javascript" src="jquery.js"></script>
    <!-- Flot -->
	<!--[if lte IE 8]><script language="javascript" type="text/javascript" src="../../excanvas.min.js"></script><![endif]-->
	<script language="javascript" type="text/javascript" src="jquery.flot.js"></script>
	<script language="javascript" type="text/javascript" src="jquery.flot.pie.js"></script>
    <!-- JQuery UI -->
    <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css" />
    <script src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
    <script src="http://jqueryui.com/resources/demos/external/jquery.mousewheel.js"></script>
    <script src="http://jqueryui.com/resources/demos/external/globalize.js"></script>
    <!-- My Stylesheet -->
	<link href="examples.css" rel="stylesheet" type="text/css">
	<style type="text/css">

	.demo-container {
		position: relative;
		height: 400px;
	}

	#placeholder {
		width: 550px;
	}

	#menu {
		position: absolute;
		top: 20px;
		left: 550px;
		bottom: 20px;
		right: 20px;
		width: 400px;
        font-family: "sans"
	}

	#menu button {
		display: inline-block;
		width: 200px;
		padding: 3px 0 2px 0;
		margin-bottom: 4px;
		background: #eee;
		border: 1px solid #999;
		border-radius: 2px;
		font-size: 16px;
		-o-box-shadow: 0 1px 2px rgba(0,0,0,0.15);
		-ms-box-shadow: 0 1px 2px rgba(0,0,0,0.15);
		-moz-box-shadow: 0 1px 2px rgba(0,0,0,0.15);
		-webkit-box-shadow: 0 1px 2px rgba(0,0,0,0.15);
		box-shadow: 0 1px 2px rgba(0,0,0,0.15);
		cursor: pointer;
	}

	#description {
		margin: 15px 10px 20px 10px;
	}

	#code {
		display: block;
		width: 870px;
		padding: 15px;
		margin: 10px auto;
		border: 1px dashed #999;
		background-color: #f8f8f8;
		font-size: 16px;
		line-height: 20px;
		color: #666;
	}

	ul {
		font-size: 10pt;
	}

	ul li {
		margin-bottom: 0.5em;
	}

	ul.options li {
		list-style: none;
		margin-bottom: 1em;
	}

	ul li i {
		color: #999;
	}

	</style>
	<script type="text/javascript">

	$(function() {
		var placeholder = $("#placeholder");

        function getAmount() {
            var amount = $("#amount").val();
            if (amount[0] == '$')
                amount = amount.substring(1);
            return parseFloat(amount)
        }

        function dollarString(num) {
            return "$"+(Math.round(num*100)/100).toFixed(2)
        }

        function calculate(amount, sbcChecked, cbfChecked, fbcChecked) {
            var data = {};

            fbc_auto_percent = 0.2;
            fbc_auto_amount = amount * fbc_auto_percent;
            data['fbc-auto'] = {data: fbc_auto_amount, ordinal: 10};

            mba_auto_percent = 0;
            mba_auto_amount = amount * mba_auto_percent;
            data['mba-auto'] = {data: mba_auto_amount, ordinal: 20};

            amount = amount - mba_auto_amount - fbc_auto_amount;

            var orgs   = ['sbc', 'cbf', 'fbc'];
            var checks = [sbcChecked, cbfChecked, fbcChecked];

            // how many are checked?
            var numChecked = 0;
            numChecked += sbcChecked ? 1 : 0;
            numChecked += cbfChecked ? 1 : 0;
            numChecked += fbcChecked ? 1 : 0;

            // if none checked, it's all undesignated
            if (numChecked == 0)
                data['undesignated'] = {data: amount, ordinal: 25};

            // compute totals for each org
            var sbcTotal = sbcChecked ? (amount/numChecked) : 0;
            var cbfTotal = cbfChecked ? (amount/numChecked) : 0;
            var fbcTotal = fbcChecked ? (amount/numChecked) : 0;
            data['sbc-total'] = {data: sbcTotal, ordinal: 30};
            data['cbf-total'] = {data: cbfTotal, ordinal: 40};
            data['fbc-total'] = {data: fbcTotal, ordinal: 50};

            // sbc details
            sbc_state_percent    = 0.57;
            sbc_state_amount     = data['sbc-total'].data * sbc_state_percent;
            sbc_national_amount  = data['sbc-total'].data - sbc_state_amount;
            data['sbc-state']    = {data: sbc_state_amount, ordinal: 31};
            data['sbc-national'] = {data: sbc_national_amount, ordinal: 32};

            // cbf details
            cbf_state_percent    = 0.20;
            cbf_state_amount     = data['cbf-total'].data * cbf_state_percent;
            cbf_national_percent = 0.50;
            cbf_national_amount  = data['cbf-total'].data * cbf_national_percent;
            cbf_asc_amount       = data['cbf-total'].data - cbf_national_amount - cbf_state_amount; // earmarked
            data['cbf-state']    = {data: cbf_state_amount, ordinal: 41};
            data['cbf-national'] = {data: cbf_national_amount, ordinal: 42};
            data['cbf-asc']      = {data: cbf_asc_amount, ordinal: 43};

            return data;
        }

        function getColor(label) {
            var alpha;
            if (/total/.test(label)) {
                alpha = 0.6;
            }
            else if (/state/.test(label)) {
                alpha = 0.45;
            }
            else {
                alpha = 0.3;
            }

            var color;
            if(/mba/.test(label))
                color = "rgba(192, 80 , 77 , " + alpha + ")";
            else if (/fbc/.test(label))
                color = "rgba(79 , 129, 189, " + alpha + ")";
            else if (/sbc/.test(label) || /asc/.test(label))
                color = "rgba(128, 100, 162, " + alpha + ")";
            else if (/cbf/.test(label))
                color = "rgba(155, 187, 89 , " + alpha + ")";
            else
                color = "rgba(0  , 0  , 0  , " + alpha + ")";

            return color;
        }

        function getLabel(label) {
            return label;
        }

        function addColors(data) {
            $.each(data, function(k, v) {
                data[k].color = getColor(k);
            });
            return data;
        }

        function addLabels(data) {
            $.each(data, function(k, v) {
                data[k].label = getLabel(k);
            });
            return data;
        }

        function sortAndReshape(data, detail) {
            var piedata = [];
            // filter and place in array
            $.each(data, function(k, v) {
                if (/auto/.test(k) || /undesignated/.test(k))
                    piedata.push(v);
                else if (!detail && /total/.test(k))
                    piedata.push(v);
                else if (detail && (/fbc/.test(k) || !/total/.test(k)))
                    piedata.push(v);
            });

            // sort
            piedata.sort(function(a, b) { return a.ordinal - b.ordinal; });

            return piedata;
        }

        function drawPlot(data) {
            function labelFormatter(label, series) {
                return "<div style='font-size:8pt; text-align:center; padding:2px; color:white; max-width: 100px;'>" +
                    label + "<br/>" + dollarString(series.data[0][1]) + "</div>";
            }

            plot = $.plot(placeholder, data, {
                series: {
                    pie: {
                        show: true
                      , radius: 1
                      , label: {
                            show: true,
                            radius: 3/4,
                            formatter: labelFormatter,
                            color: "#000",
                            background: {
                                opacity: 0.2
                               , color: '#000'
                            }
                        }
                    }
                }
              , legend: {
                  show: false
                }
            });
        }

        function redraw() {
			placeholder.unbind();

            var amount = getAmount();
            var missionsAmount = amount * 0.12
            $("#toMissionsAmount").text(dollarString(missionsAmount));

            var sbcChecked = $("#sbc-checkbox").is(":checked")
            var cbfChecked = $("#cbf-checkbox").is(":checked")
            var fbcChecked = $("#fbc-checkbox").is(":checked")
            var detailChecked = $("#detail-checkbox").is(":checked")

            data = calculate(missionsAmount, sbcChecked, cbfChecked, fbcChecked);
            data = addColors(data);
            data = addLabels(data);
            data = sortAndReshape(data, detailChecked);

            drawPlot(data);
        }

		$(document).ready(function() { redraw(); });
        $(".orgCheckbox").change(function() { redraw(); });
        $("#detail-checkbox").change(function() { redraw(); });
        $("#amount").change(function() { redraw(); });
        $("#amount").spinner({
            min: 0,
            step: 10,
            start: 100,
            numberFormat: "C",
        });
        $("#amount").on("spinstop", function() { redraw(); });
    });
	</script>
</head>
<body>

	<div id="header">
		<h2>Missions Giving</h2>
	</div>

	<div id="content">

		<h3 id="title">How your money is allocated</h3>
		<div class="demo-container">
			<div id="placeholder" class="demo-placeholder"></div>
            <div id="menu">
                <p>Your gift amount:<br/>
                <input id="amount" name="amount" value="100" /><br></p>
                <p id="toMissions">Total amount "To missions": <span id="toMissionsAmount">$10.00</span></p>
                <p><input class="orgCheckbox" type="checkbox" id="sbc-checkbox" name="SBC" value="SBC" checked/>SBC</p>
                <p><input class="orgCheckbox" type="checkbox" id="cbf-checkbox" name="CBF" value="CBF" checked/>CBF</p>
                <p><input class="orgCheckbox" type="checkbox" id="fbc-checkbox" name="FBC" value="FBC" checked/>FBC</p>
                <p><hr width="200px"></p>
                <p><input type="checkbox" id="detail-checkbox" name="detail" value="detail" />Show detail</p>
            </div>
		</div>

	</div>

</body>
</html>
